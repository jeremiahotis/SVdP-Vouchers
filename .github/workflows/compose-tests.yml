name: Compose Test Suite

on:
  push:
    branches: [ main, feature/* ]
  pull_request:
    branches: [ main, feature/* ]

jobs:
  compose-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Prepare env
        run: |
          cp .env.example .env
          echo "GIT_SHA=${GITHUB_SHA}" >> .env

      - name: Verify release gates doc
        run: |
          git ls-files --error-unmatch docs/RELEASE_GATES.md
          test -s docs/RELEASE_GATES.md

      - name: Run compose tests
        run: |
          chmod +x infra/scripts/compose.sh
          infra/scripts/compose.sh run --rm api-test pnpm test:db
